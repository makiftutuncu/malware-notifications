package dev.akif.malwarenotifications.persistence.detection;

import dev.akif.malwarenotifications.persistence.device.DeviceRepository;
import lombok.NonNull;

import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

public class InMemoryDetectionRepository implements DetectionRepository {
    private final DeviceRepository devices;
    private final Map<UUID, DetectionEntity> detections = new HashMap<>();

    private final Comparator<DetectionEntity> defaultSorting =
            Comparator
                    .comparing(DetectionEntity::getTime).reversed()
                    .thenComparing(DetectionEntity::getAppName);

    public InMemoryDetectionRepository(@NonNull DeviceRepository devices, @NonNull DetectionEntity... detectionEntities) {
        this.devices = devices;
        for (DetectionEntity detectionEntity : detectionEntities) {
            detections.put(detectionEntity.getId(), detectionEntity);
        }
    }

    @Override
    public @NonNull List<DetectionEntity> findAll() {
        return detections
                .values()
                .stream()
                .sorted(defaultSorting)
                .toList();
    }

    @Override
    public @NonNull List<DetectionEntity> findByDeviceId(@NonNull UUID deviceId) {
        return detections
                .values()
                .stream()
                .filter(d -> d.getDevice().getId().equals(deviceId))
                .sorted(defaultSorting)
                .toList();
    }

    @Override
    public void createOrUpdateAll(@NonNull List<DetectionEntity> detectionEntities) {
        for (DetectionEntity detectionEntity : detectionEntities) {
            detections.put(detectionEntity.getId(), detectionEntity);
            devices.createOrUpdate(detectionEntity.getDevice());
        }
    }
}
